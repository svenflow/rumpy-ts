<!DOCTYPE html>
<html><head><meta charset="UTF-8"></head><body><pre id="log"></pre>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@4.22.0/dist/tf-backend-wasm.min.js"></script>
<script type="module">
const L = document.getElementById('log');
const log = m => { L.textContent += m + '\n'; console.log(m); };

const NT = 8;
tf.wasm.setThreadsCount(NT);
await tf.setBackend('wasm'); await tf.ready();

const r = await import('./pkg/rumpy_wasm.js');
await r.default();
await r.initThreadPool(NT);
log(`tfjs + rumpy ready (${NT}t each)\n`);

function med(fn, n=5) {
  for(let i=0;i<3;i++) fn();
  const t=[]; for(let i=0;i<n;i++){const s=performance.now();fn();t.push(performance.now()-s);}
  t.sort((a,b)=>a-b); return t[n>>1];
}
function maxDiff(a,b) { let m=0; for(let i=0;i<a.length;i++){const d=Math.abs(a[i]-b[i]); if(d>m)m=d;} return m; }

log('Multi-threaded head-to-head (8t vs 8t):');
log('size | tfjs-8t | rumpy-v3 | vs tfjs | correctness');
log('-----+---------+----------+---------+------------');

for (const n of [128, 256, 512, 1024, 1536, 2048, 3072, 4096]) {
  const A = new Float32Array(n*n).map(Math.random);
  const B = new Float32Array(n*n).map(Math.random);

  // tfjs
  const tA = tf.tensor2d(A,[n,n]), tB = tf.tensor2d(B,[n,n]);
  const iters = n >= 2048 ? 3 : 5;
  const tf_t = med(() => { const c=tf.matMul(tA,tB); c.dataSync(); c.dispose(); }, iters);
  const ref = (()=>{const c=tf.matMul(tA,tB);const d=c.dataSync();c.dispose();return d;})();
  tA.dispose(); tB.dispose();

  // rumpy v3
  const v3_t = med(() => r.matmulF32OptimizedParallelV3(A,B,n,n,n), iters);
  const out = r.matmulF32OptimizedParallelV3(A,B,n,n,n);
  const err = maxDiff(out, ref);
  const ok = err < 1e-2 ? 'âœ…' : `âŒ ${err.toExponential(1)}`;

  const ratio = v3_t / tf_t;
  const marker = ratio <= 1.0 ? ' â­' : (ratio <= 1.1 ? ' ðŸŽ¯' : '');

  log(`${n.toString().padStart(4)} | ${tf_t.toFixed(2).padStart(7)} | ${v3_t.toFixed(2).padStart(8)} | ${ratio.toFixed(2).padStart(5)}Ã—${marker} | ${ok}`);
}

log('\nâ­ = beats tfjs  ðŸŽ¯ = within 10%');
window.DONE = true;
</script></body></html>
